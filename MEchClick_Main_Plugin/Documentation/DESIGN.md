# PartManager - 상세 설계 문서

## 1. 클래스 다이어그램

### 1.1 전체 클래스 구조

```
┌────────────────────────────────────────────────────────────────────────────────────┐
│                                  PartManager                                        │
├────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────┐                                                           │
│  │    PluginLoader     │◀──── [assembly: ExtensionApplication]                     │
│  ├─────────────────────┤                                                           │
│  │ +Initialize()       │                                                           │
│  │ +Terminate()        │                                                           │
│  └──────────┬──────────┘                                                           │
│             │ uses                                                                  │
│             ▼                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────┐  │
│  │                              Managers                                        │  │
│  │  ┌─────────────────────┐    ┌─────────────────────┐                         │  │
│  │  │  DatabaseManager    │    │   PaletteManager    │                         │  │
│  │  ├─────────────────────┤    ├─────────────────────┤                         │  │
│  │  │ -_instance: static  │    │ -_paletteSet        │                         │  │
│  │  │ -_connection        │    │ -_selectorPanel     │                         │  │
│  │  │ +Instance: prop     │    │ -_ipcClient         │                         │  │
│  │  ├─────────────────────┤    ├─────────────────────┤                         │  │
│  │  │ +Initialize()       │    │ +Initialize()       │                         │  │
│  │  │ +ExecuteReader()    │    │ +Show()             │                         │  │
│  │  │ +ExecuteNonQuery()  │    │ +Hide()             │                         │  │
│  │  │ +Dispose()          │    │ +Toggle()           │                         │  │
│  │  └─────────────────────┘    │ +SetDockPosition()  │                         │  │
│  │          ▲                  │ +GetIPCStatus()     │                         │  │
│  │          │                  │ +ReconnectIPC()     │                         │  │
│  │          │                  │ +Cleanup()          │                         │  │
│  │          │                  └──────────┬──────────┘                         │  │
│  └──────────┼────────────────────────────┼─────────────────────────────────────┘  │
│             │                             │                                        │
│             │ uses                        │ contains                               │
│             ▼                             ▼                                        │
│  ┌─────────────────────┐    ┌─────────────────────────────────────────┐           │
│  │ PaletteSettings     │    │      CategorySelectorPanel              │           │
│  ├─────────────────────┤    │         (WPF UserControl)               │           │
│  │ +DockPosition       │    ├─────────────────────────────────────────┤           │
│  │ +Location           │    │ -_mainCategories: List<MainCategoryItem>│           │
│  │ +FloatingSize       │    │ -_subCategories: List<SubCategoryItem>  │           │
│  │ +DockedSize         │    │ -_midCategories: List<MidCategoryItem>  │           │
│  │ +Visible            │    │ -_partTypes: List<PartTypeItem>         │           │
│  ├─────────────────────┤    │ -_series: List<SeriesItem>              │           │
│  │ +Load(): Settings   │    │ -_isGridMode: bool                      │           │
│  │ +Save(): void       │    ├─────────────────────────────────────────┤           │
│  └─────────────────────┘    │ +UpdateConnectionStatus()               │           │
│                             │ +ShowMessage()                          │           │
│                             │ -OnSizeChanged()                        │           │
│                             │ -SwitchDisplayMode()                    │           │
│                             │ -LoadMainCategories()                   │           │
│                             │ -SelectMainCategory()                   │           │
│                             │ +event PartSelected                     │           │
│                             └─────────────────────────────────────────┘           │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐  │
│  │                                IPC Layer                                     │  │
│  │  ┌─────────────────────┐    ┌─────────────────────┐                         │  │
│  │  │    IPCMessage       │    │  NamedPipeClient    │                         │  │
│  │  ├─────────────────────┤    ├─────────────────────┤                         │  │
│  │  │ +Command: string    │    │ -_pipeClient        │                         │  │
│  │  │ +Parameters: Dict   │    │ -_reader            │                         │  │
│  │  │ +MessageId: string  │    │ -_writer            │                         │  │
│  │  │ +Timestamp: long    │    │ +IsConnected: bool  │                         │  │
│  │  └─────────────────────┘    ├─────────────────────┤                         │  │
│  │                             │ +ConnectAsync()     │                         │  │
│  │  ┌─────────────────────┐    │ +SendMessageAsync() │                         │  │
│  │  │   IPCResponse       │    │ +SendCommandAsync() │                         │  │
│  │  ├─────────────────────┤    │ +Disconnect()       │                         │  │
│  │  │ +Success: bool      │    │ +event MessageReceived                        │  │
│  │  │ +Message: string    │    │ +event ConnectionStatusChanged                │  │
│  │  │ +Data: Dict         │    └─────────────────────┘                         │  │
│  │  │ +MessageId: string  │                                                     │  │
│  │  └─────────────────────┘                                                     │  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐  │
│  │                              Commands                                        │  │
│  │  ┌─────────────────────┐                                                     │  │
│  │  │    UICommands       │◀──── [assembly: CommandClass]                       │  │
│  │  ├─────────────────────┤                                                     │  │
│  │  │ [CommandMethod]     │                                                     │  │
│  │  │ +ShowUI()           │  → SHOWUI                                           │  │
│  │  │ +HideUI()           │  → HIDEUI                                           │  │
│  │  │ +ToggleUI()         │  → TOGGLEUI                                         │  │
│  │  │ +DockUI()           │  → DOCKUI                                           │  │
│  │  │ +OpenPartSelector() │  → PARTSELECT                                       │  │
│  │  │ +CheckIPCStatus()   │  → IPCSTATUS                                        │  │
│  │  │ +ReconnectIPC()     │  → IPCRECONNECT                                     │  │
│  │  │ +ShowDebugInfo()    │  → UIDEBUG                                          │  │
│  │  └─────────────────────┘                                                     │  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
└────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 데이터 모델 클래스

```
┌───────────────────────────────────────────────────────────────────────────────────┐
│                              Data Models                                           │
│  (CategorySelectorPanel 내부 클래스)                                               │
├───────────────────────────────────────────────────────────────────────────────────┤
│                                                                                    │
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐   │
│  │  MainCategoryItem   │    │  SubCategoryItem    │    │  MidCategoryItem    │   │
│  ├─────────────────────┤    ├─────────────────────┤    ├─────────────────────┤   │
│  │ +MainCatCode        │    │ +SubCatCode         │    │ +MidCatCode         │   │
│  │ +MainCatNameKr      │    │ +SubCatNameKr       │    │ +MidCatNameKr       │   │
│  │ +IsStandard         │    │ +MainCatCode        │    │ +SubCatCode         │   │
│  │ +ColorCode          │    │ +IsVendor           │    └─────────────────────┘   │
│  └─────────────────────┘    │ +Country            │                              │
│                             └─────────────────────┘                              │
│                                                                                    │
│  ┌─────────────────────┐    ┌─────────────────────┐                              │
│  │   PartTypeItem      │    │    SeriesItem       │                              │
│  ├─────────────────────┤    ├─────────────────────┤                              │
│  │ +PartTypeCode       │    │ +SeriesCode         │                              │
│  │ +PartTypeNameKr     │    │ +SeriesName         │                              │
│  │ +SubCatCode         │    │ +PartTypeCode       │                              │
│  │ +MidCatCode         │    └─────────────────────┘                              │
│  │ +HasSeries          │                                                          │
│  └─────────────────────┘                                                          │
│                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        PartSelectedEventArgs                                 │ │
│  ├─────────────────────────────────────────────────────────────────────────────┤ │
│  │ +MainCategory: string     │ 선택된 메인 카테고리 이름                        │ │
│  │ +SubCategory: string      │ 선택된 서브 카테고리 이름                        │ │
│  │ +MidCategory: string      │ 선택된 중분류 이름 (표준부품만)                  │ │
│  │ +PartType: string         │ 선택된 부품타입 이름                             │ │
│  │ +Series: string           │ 선택된 시리즈 이름 (해당 시)                     │ │
│  │ +PartCode: string         │ 최종 부품 코드                                   │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                    │
└───────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 시퀀스 다이어그램

### 2.1 플러그인 초기화

```
┌─────────┐  ┌──────────────┐  ┌─────────────────┐  ┌────────────────┐  ┌─────────────────────┐
│ AutoCAD │  │ PluginLoader │  │ DatabaseManager │  │ PaletteManager │  │ CategorySelectorPanel│
└────┬────┘  └──────┬───────┘  └────────┬────────┘  └───────┬────────┘  └──────────┬──────────┘
     │              │                    │                   │                      │
     │  NETLOAD     │                    │                   │                      │
     │─────────────▶│                    │                   │                      │
     │              │                    │                   │                      │
     │              │  Initialize()      │                   │                      │
     │              │───────────────────▶│                   │                      │
     │              │                    │                   │                      │
     │              │                    │  SQLite 연결      │                      │
     │              │                    │  ───────────┐     │                      │
     │              │                    │             │     │                      │
     │              │                    │◀────────────┘     │                      │
     │              │                    │                   │                      │
     │              │  Initialize()      │                   │                      │
     │              │───────────────────────────────────────▶│                      │
     │              │                    │                   │                      │
     │              │                    │                   │  PaletteSet 생성     │
     │              │                    │                   │  ───────────┐        │
     │              │                    │                   │             │        │
     │              │                    │                   │◀────────────┘        │
     │              │                    │                   │                      │
     │              │                    │                   │  new()               │
     │              │                    │                   │─────────────────────▶│
     │              │                    │                   │                      │
     │              │                    │                   │  ElementHost 생성    │
     │              │                    │                   │◀─────────────────────│
     │              │                    │                   │                      │
     │              │                    │                   │  IPC 클라이언트      │
     │              │                    │                   │  초기화              │
     │              │                    │                   │  ───────────┐        │
     │              │                    │                   │             │        │
     │              │                    │                   │◀────────────┘        │
     │              │                    │                   │                      │
     │              │  Show()            │                   │                      │
     │              │───────────────────────────────────────▶│                      │
     │              │                    │                   │                      │
     │              │                    │                   │  PaletteSet.Visible  │
     │              │                    │                   │  = true              │
     │              │                    │                   │  ───────────┐        │
     │              │                    │                   │             │        │
     │              │                    │                   │◀────────────┘        │
     │              │                    │                   │                      │
     │  로드 완료   │                    │                   │                      │
     │◀─────────────│                    │                   │                      │
     │              │                    │                   │                      │
```

### 2.2 부품 선택 흐름

```
┌──────┐  ┌─────────────────────┐  ┌─────────────────┐  ┌────────────────┐  ┌─────────────────┐
│ User │  │ CategorySelectorPanel│  │ DatabaseManager │  │ PaletteManager │  │ NamedPipeClient │
└──┬───┘  └──────────┬──────────┘  └────────┬────────┘  └───────┬────────┘  └────────┬────────┘
   │                 │                       │                   │                    │
   │  메인카테고리   │                       │                   │                    │
   │  클릭 (표준부품)│                       │                   │                    │
   │────────────────▶│                       │                   │                    │
   │                 │                       │                   │                    │
   │                 │  LoadSubCategories()  │                   │                    │
   │                 │──────────────────────▶│                   │                    │
   │                 │                       │                   │                    │
   │                 │  SELECT * FROM        │                   │                    │
   │                 │  SubCategory          │                   │                    │
   │                 │◀──────────────────────│                   │                    │
   │                 │                       │                   │                    │
   │                 │  UI 갱신              │                   │                    │
   │                 │  (Section 2 표시)     │                   │                    │
   │                 │  ───────────┐         │                   │                    │
   │                 │             │         │                   │                    │
   │                 │◀────────────┘         │                   │                    │
   │                 │                       │                   │                    │
   │  서브카테고리   │                       │                   │                    │
   │  클릭 (체결류)  │                       │                   │                    │
   │────────────────▶│                       │                   │                    │
   │                 │                       │                   │                    │
   │                 │  LoadMidCategories()  │                   │                    │
   │                 │──────────────────────▶│                   │                    │
   │                 │                       │                   │                    │
   │                 │  결과 반환            │                   │                    │
   │                 │◀──────────────────────│                   │                    │
   │                 │                       │                   │                    │
   │  ... (중분류, 부품타입 선택 반복) ...   │                   │                    │
   │                 │                       │                   │                    │
   │  [부품 선택 →]  │                       │                   │                    │
   │  버튼 클릭      │                       │                   │                    │
   │────────────────▶│                       │                   │                    │
   │                 │                       │                   │                    │
   │                 │  PartSelected 이벤트  │                   │                    │
   │                 │──────────────────────────────────────────▶│                    │
   │                 │                       │                   │                    │
   │                 │                       │                   │  IPCMessage 생성   │
   │                 │                       │                   │  ───────────┐      │
   │                 │                       │                   │             │      │
   │                 │                       │                   │◀────────────┘      │
   │                 │                       │                   │                    │
   │                 │                       │                   │  SendCommandAsync()│
   │                 │                       │                   │───────────────────▶│
   │                 │                       │                   │                    │
   │                 │                       │                   │                    │  Named Pipe
   │                 │                       │                   │                    │  ──────────▶
   │                 │                       │                   │                    │  (C++ ARX)
   │                 │                       │                   │                    │
   │                 │                       │                   │  전송 완료         │
   │                 │                       │                   │◀───────────────────│
   │                 │                       │                   │                    │
   │                 │  ShowMessage()        │                   │                    │
   │                 │◀──────────────────────────────────────────│                    │
   │                 │                       │                   │                    │
   │  "선택: XXX"    │                       │                   │                    │
   │  메시지 표시    │                       │                   │                    │
   │◀────────────────│                       │                   │                    │
   │                 │                       │                   │                    │
```

### 2.3 반응형 레이아웃 전환

```
┌──────┐  ┌─────────────────────┐
│ User │  │ CategorySelectorPanel│
└──┬───┘  └──────────┬──────────┘
   │                 │
   │  패널 크기 조절 │
   │────────────────▶│
   │                 │
   │                 │  OnSizeChanged()
   │                 │  ───────────┐
   │                 │             │
   │                 │◀────────────┘
   │                 │
   │                 │  너비 >= 650px ?
   │                 │  ───────────┐
   │                 │             │
   │                 │◀────────────┘
   │                 │
   │                 │  [너비 >= 650px]
   │                 │  SwitchDisplayMode()
   │                 │  → _isGridMode = true
   │                 │  ───────────┐
   │                 │             │
   │                 │◀────────────┘
   │                 │
   │                 │  accordionContainer.Visibility
   │                 │  = Collapsed
   │                 │  ───────────┐
   │                 │             │
   │                 │◀────────────┘
   │                 │
   │                 │  gridContainer.Visibility
   │                 │  = Visible
   │                 │  ───────────┐
   │                 │             │
   │                 │◀────────────┘
   │                 │
   │                 │  RefreshGridUI()
   │                 │  → 모든 Grid 패널 갱신
   │                 │  → 선택 상태 복원
   │                 │  ───────────┐
   │                 │             │
   │                 │◀────────────┘
   │                 │
   │  Grid 모드 표시 │
   │◀────────────────│
   │                 │
```

---

## 3. 상태 다이어그램

### 3.1 UI 모드 상태

```
                    ┌─────────────────────────────────────────────┐
                    │                                             │
                    ▼                                             │
     ┌──────────────────────────┐                                │
     │                          │                                │
     │      Accordion Mode      │                                │
     │     (너비 < 650px)       │                                │
     │                          │                                │
     └────────────┬─────────────┘                                │
                  │                                               │
                  │ 너비 >= 650px                                 │
                  │ (OnSizeChanged)                               │
                  ▼                                               │
     ┌──────────────────────────┐                                │
     │                          │                                │
     │       Grid Mode          │────────────────────────────────┘
     │     (너비 >= 650px)      │     너비 < 650px
     │                          │     (OnSizeChanged)
     └──────────────────────────┘
```

### 3.2 Accordion 섹션 상태

```
     ┌──────────────────────────┐
     │                          │
     │       Collapsed          │◀──────────────────┐
     │     (▶ 화살표)           │                   │
     │                          │                   │
     └────────────┬─────────────┘                   │
                  │                                 │
                  │ 헤더 클릭                       │ 헤더 클릭
                  │ 또는                           │ 또는
                  │ 하위 항목 선택                  │ 상위 항목 선택
                  ▼                                 │
     ┌──────────────────────────┐                   │
     │                          │                   │
     │       Expanded           │───────────────────┘
     │     (▼ 화살표)           │
     │                          │
     └──────────────────────────┘
```

### 3.3 IPC 연결 상태

```
                    ┌─────────────────────────────────────────────┐
                    │                                             │
     시작           ▼                                             │
      │   ┌──────────────────────────┐                           │
      │   │                          │                           │
      └──▶│      Disconnected        │                           │
          │     (연결 안됨 - 빨강)   │                           │
          │                          │                           │
          └────────────┬─────────────┘                           │
                       │                                          │
                       │ ConnectAsync() 성공                      │
                       │                                          │
                       ▼                                          │
          ┌──────────────────────────┐                           │
          │                          │                           │
          │       Connected          │───────────────────────────┘
          │     (연결됨 - 녹색)      │     연결 끊김
          │                          │     또는 오류
          └──────────────────────────┘
```

---

## 4. 컴포넌트 의존성 다이어그램

```
┌────────────────────────────────────────────────────────────────────────────────────┐
│                                  외부 의존성                                        │
├────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐               │
│   │   AutoCAD API   │    │  System.Data    │    │  Newtonsoft     │               │
│   │   (ObjectARX)   │    │    .SQLite      │    │     .Json       │               │
│   └────────┬────────┘    └────────┬────────┘    └────────┬────────┘               │
│            │                      │                      │                         │
└────────────┼──────────────────────┼──────────────────────┼─────────────────────────┘
             │                      │                      │
             ▼                      ▼                      ▼
┌────────────────────────────────────────────────────────────────────────────────────┐
│                              PartManager 내부                                       │
├────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌─────────────────┐                                                              │
│   │  PluginLoader   │                                                              │
│   │ (진입점)        │                                                              │
│   └────────┬────────┘                                                              │
│            │                                                                        │
│            │ 의존                                                                   │
│            ▼                                                                        │
│   ┌─────────────────┐────────────────────▶┌─────────────────┐                     │
│   │ PaletteManager  │      의존           │ DatabaseManager │                     │
│   │ (UI 관리)       │                     │ (데이터 접근)   │                     │
│   └────────┬────────┘                     └────────┬────────┘                     │
│            │                                       │                               │
│            │ 포함                                  │ 사용                          │
│            ▼                                       ▼                               │
│   ┌─────────────────────┐              ┌─────────────────┐                        │
│   │ CategorySelector    │──────────────│   SQLite DB     │                        │
│   │ Panel (WPF)         │    조회      │  (Core+Vendors) │                        │
│   └────────┬────────────┘              └─────────────────┘                        │
│            │                                                                        │
│            │ 이벤트                                                                 │
│            ▼                                                                        │
│   ┌─────────────────┐────────────────────▶┌─────────────────┐                     │
│   │ PaletteManager  │      사용           │ NamedPipeClient │                     │
│   │ (이벤트 수신)   │                     │ (IPC 통신)      │                     │
│   └─────────────────┘                     └────────┬────────┘                     │
│                                                    │                               │
│                                                    │ 사용                          │
│                                                    ▼                               │
│                                           ┌─────────────────┐                     │
│                                           │   IPCMessage    │                     │
│                                           │   IPCResponse   │                     │
│                                           └─────────────────┘                     │
│                                                                                     │
│   ┌─────────────────┐                     ┌─────────────────┐                     │
│   │   UICommands    │─────────의존───────▶│ PaletteManager  │                     │
│   │ (CAD 명령어)    │                     │                 │                     │
│   └─────────────────┘                     └─────────────────┘                     │
│                                                                                     │
│   ┌─────────────────┐                     ┌─────────────────┐                     │
│   │ PaletteSettings │◀────────사용────────│ PaletteManager  │                     │
│   │ (설정 저장)     │                     │                 │                     │
│   └─────────────────┘                     └─────────────────┘                     │
│                                                                                     │
└────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 파일별 책임

| 파일 | 책임 | LOC (대략) |
|------|------|------------|
| `PluginLoader.cs` | AutoCAD 플러그인 진입점, 초기화/종료 | ~70 |
| `UICommands.cs` | AutoCAD 명령어 정의 및 실행 | ~170 |
| `DatabaseManager.cs` | SQLite 연결 관리, 쿼리 실행 | ~400 |
| `MultiDatabaseRepository.cs` | 다중 DB 조회 로직 | ~800 |
| `PaletteManager.cs` | PaletteSet 생성, IPC 연동, 이벤트 처리 | ~400 |
| `PaletteSettings.cs` | Registry 기반 설정 저장/로드 | ~200 |
| `CategorySelectorPanel.xaml` | WPF UI 정의 (XAML) | ~200 |
| `CategorySelectorPanel.xaml.cs` | UI 로직, 반응형 전환, 데이터 바인딩 | ~900 |
| `IPCMessage.cs` | IPC 메시지 구조 정의 | ~40 |
| `NamedPipeClient.cs` | Named Pipe 클라이언트 구현 | ~190 |

---

## 6. 확장 포인트

### 6.1 새로운 업체 추가

1. `Database/vendors/` 폴더에 `vendor_xxx.db` 파일 추가
2. `config.json`의 `VendorFiles`에 매핑 추가
3. `config.json`의 `EnabledVendors`에 업체 코드 추가

### 6.2 새로운 CAD 명령어 추가

1. `UICommands.cs`에 새로운 메서드 추가
2. `[CommandMethod("COMMAND_NAME")]` 어트리뷰트 적용

### 6.3 IPC 명령어 확장

1. `IPCMessage.Command`에 새로운 명령어 문자열 정의
2. C++ ARX 서버에서 해당 명령어 처리 로직 구현

---

*문서 작성일: 2024-12*
