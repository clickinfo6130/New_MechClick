# Excel 동적 계층형 콤보박스 UI - Ver 09 개선사항

## 📅 업데이트 날짜
2025-11-26

## 🎯 개선 목표
"종류" (컬럼 2)를 콤보박스로 변경하여 여러 볼트 종류를 선택할 수 있도록 개선

---

## 📋 변경 내용

### 1. 파일: `UI/DynamicUIManager.cs`

#### 신규 멤버 변수 추가

```csharp
// ✅ 종류 콤보박스 관련
private string _categoryColumnName;           // 종류 컬럼 이름 (Headers[1])
private List<string> _allCategories;          // 모든 종류 목록
private string _selectedCategory;             // 현재 선택된 종류
private ComboBox _categoryComboBox;           // 종류 콤보박스
private List<int> _hierarchyColumns;          // 계층 컬럼 인덱스
private bool _isUpdatingCategory = false;     // 종류 변경 중 플래그
private BoltSpecData _filteredData;           // 종류별 필터링된 데이터
```

#### 신규 메서드

**1. `GetAllCategories()` - 모든 종류 목록 수집**
```csharp
private List<string> GetAllCategories()
{
    var categories = new HashSet<string>();
    
    foreach (var row in _data.DataRows)
    {
        if (row.CompleteValues.ContainsKey(_categoryColumnName))
        {
            var value = row.CompleteValues[_categoryColumnName]?.Trim();
            if (!string.IsNullOrWhiteSpace(value))
            {
                categories.Add(value);
            }
        }
    }
    
    return categories.OrderBy(c => c).ToList();
}
```

**2. `FilterDataByCategory(string category)` - 종류별 데이터 필터링**
```csharp
private BoltSpecData FilterDataByCategory(string category)
{
    var filtered = new BoltSpecData
    {
        Headers = _data.Headers
    };
    
    foreach (var row in _data.DataRows)
    {
        if (row.CompleteValues.ContainsKey(_categoryColumnName))
        {
            var value = row.CompleteValues[_categoryColumnName]?.Trim();
            if (value == category)
            {
                filtered.DataRows.Add(row);
            }
        }
    }
    
    return filtered;
}
```

**3. `DisplayCategoryComboBox()` - 종류 콤보박스 생성**
- 기존 `DisplayCategory()` 메서드를 대체
- Label + ComboBox 조합으로 구성
- SelectionChanged 이벤트 연결

**4. `OnCategorySelectionChanged()` - 종류 선택 이벤트 처리**
- 선택된 종류로 데이터 필터링
- `BuildUIForCurrentCategory()` 호출하여 UI 재구성

**5. `BuildUIForCurrentCategory()` - 현재 종류에 대한 UI 구성**
- 캔버스 초기화
- 필터링된 데이터로 계층 트리 구축
- 컨트롤 생성
- 첫 번째 계층 컨트롤 자동 선택

**6. `AutoSelectFirstHierarchyControl()` - 첫 번째 계층 자동 선택**
- UI 구성 후 첫 번째 계층 컨트롤의 첫 번째 아이템 자동 선택
- 연쇄 자동 선택 시작점

#### 수정된 메서드

**필터링된 데이터 사용하도록 수정:**
- `CreateDynamicControl()` 
- `CreateLeafControl()`
- `UpdateDependentControls()`
- `UpdateLeafControls()`
- `GetSampleValue()`

---

## 🔄 동작 흐름

### 프로그램 시작 시

```
1. Excel 파일 로드
2. BuildUI() 호출
   ├── 모든 종류 목록 수집 (GetAllCategories)
   │   └── 결과: [T홈볼트, U볼트, 경첩볼트, ..., 육각머리볼트, ...]
   │
   ├── 종류 콤보박스 생성 (DisplayCategoryComboBox)
   │   └── 콤보박스에 20개 종류 추가
   │
   └── 첫 번째 종류 자동 선택 (SelectedIndex = 0)
       └── SelectionChanged 이벤트 발생
           └── OnCategorySelectionChanged() 호출
```

### 종류 선택 시

```
1. OnCategorySelectionChanged() 이벤트
   │
2. FilterDataByCategory() 호출
   ├── 전체 데이터에서 선택된 종류만 필터링
   └── 예: "육각머리볼트" → 해당 행들만 추출
   │
3. BuildUIForCurrentCategory() 호출
   ├── Canvas 초기화
   ├── 필터링된 데이터로 계층 트리 구축
   ├── 계층형 컨트롤 생성 (국제산업표준 → 규격 → 용도 → ...)
   ├── 리프 컨트롤 생성 (표면처리, 볼트끝단, ...)
   └── AutoSelectFirstHierarchyControl() 호출
       └── 첫 번째 계층 컨트롤 자동 선택
           └── 연쇄 자동 선택 (Ver 08 기능)
```

---

## 📊 지원되는 볼트 종류 (SampleData_01.xlsx 기준)

1. T홈볼트
2. U볼트
3. 경첩볼트
4. 관용볼트
5. 기초볼트
6. 나비볼트
7. 노크볼트
8. 렌치볼트
9. 무두렌치볼트
10. 사각볼트
11. 샘스볼트
12. 숄더볼트
13. 스터드볼트
14. 아이볼트
15. 앙카볼트
16. 육각구멍볼트
17. 육각머리볼트
18. 접시머리볼트
19. 턴버클
20. 플랜지붙이육각볼트

---

## 💡 사용자 경험 개선

### Before (Ver 08)

**화면 상단:**
```
종류: 육각머리볼트 (고정 텍스트)
```

**문제점:**
- 단일 종류만 표시
- 다른 종류 선택 불가
- Excel 파일 교체 필요

### After (Ver 09)

**화면 상단:**
```
종류: [육각머리볼트 ▼] (콤보박스)
       ├── T홈볼트
       ├── U볼트
       ├── 경첩볼트
       ├── ...
       └── 플랜지붙이육각볼트
```

**개선점:**
- 20개 볼트 종류 선택 가능
- 선택 즉시 하위 계층 데이터 변경
- 자동 연쇄 선택으로 빠른 작업

---

## 🧪 테스트 시나리오

### 시나리오 1: 종류 변경

**절차:**
1. 프로그램 시작 (기본: 첫 번째 종류 선택)
2. 종류 콤보박스에서 "육각구멍볼트" 선택
3. 하위 계층 컨트롤 확인

**예상 결과:**
```
✅ 국제산업표준 → 육각구멍볼트에 해당하는 항목들로 변경
✅ 규격 → 육각구멍볼트 관련 규격으로 변경
✅ 용도 → 육각구멍볼트에서 사용 가능한 용도로 변경
✅ 모든 하위 레벨 자동 선택됨
```

### 시나리오 2: 연속 종류 변경

**절차:**
1. "육각머리볼트" 선택
2. 0.5초 후 "T홈볼트" 선택
3. 0.5초 후 "U볼트" 선택

**예상 결과:**
```
✅ 각 변경 시마다 UI가 즉시 갱신됨
✅ 최종 선택 "U볼트"에 맞는 데이터 표시
✅ 이전 데이터가 남아있지 않음
```

### 시나리오 3: 빈 데이터 처리

**절차:**
1. 특정 종류 선택
2. 해당 종류에 특정 계층 데이터가 없는 경우 확인

**예상 결과:**
```
✅ 데이터가 없는 컨트롤은 비활성화됨
✅ 사용 가능한 컨트롤만 활성화됨
✅ 에러 없이 정상 동작
```

---

## 📁 파일 구조

```
BoltSpecProgram_09/
├── UI/
│   └── DynamicUIManager.cs  ← 주요 변경
├── Services/
│   ├── IpcMessage.cs
│   ├── IpcServer.cs
│   └── JsonExporter.cs
├── Properties/
├── App.xaml
├── App.xaml.cs
├── BoltSpecData.cs
├── BoltSpecProgram.csproj
├── ExcelReader.cs
├── MainWindow.xaml
├── MainWindow.xaml.cs
├── packages.config
└── SampleData.xlsx          ← 새 샘플 파일 (20개 종류)
```

---

## 🔧 향후 개선 가능 사항

1. **최근 선택 기억**
   - 프로그램 종료 후 재시작 시 마지막 선택 종류 기억

2. **종류별 즐겨찾기**
   - 자주 사용하는 종류를 상단에 표시

3. **종류 검색**
   - 많은 종류가 있을 때 검색 기능 추가

4. **종류별 색상 구분**
   - 시각적 구분을 위한 색상 표시

---

## 📝 버전 히스토리

### Ver 09 (2025-11-26)
- **개선**: "종류" 컬럼을 콤보박스로 변경
- **개선**: 20개 볼트 종류 선택 가능
- **개선**: 종류 변경 시 자동 데이터 필터링 및 UI 재구성
- **개선**: 새 샘플 데이터 파일 포함 (SampleData_01.xlsx)

### Ver 08 (2025-11-25)
- **개선**: 상위 레벨 선택 시 하위 레벨 자동 선택 기능 추가

### Ver 07 (이전 버전)
- **기능**: 계층형 필터링 기본 기능
- **한계**: 단일 종류만 지원

---

**End of Document**
