# Excel 동적 계층형 콤보박스 UI - 아키텍처 요약

## 🎯 핵심 개념 (30초 요약)

Excel 파일의 데이터를 읽어 계층적 트리 구조로 변환하고, 이를 기반으로 동적 UI를 생성하여 상위 선택에 따라 하위 옵션이 자동 필터링되는 WPF 애플리케이션

---

## 📊 4계층 아키텍처

```
[Presentation]     MainWindow.xaml/cs         - UI 이벤트 처리
      ↓↑
[UI Manager]       DynamicUIManager           - 동적 UI 생성/관리
      ↓↑
[Business Logic]   HierarchyTreeBuilder       - 계층 트리 구축/필터링
                   ExcelReader                - Excel 데이터 읽기
      ↓↑
[Data]            BoltSpecData               - 데이터 모델
                   HierarchyNode              - 트리 노드
                   ControlInfo                - UI 컨트롤 정보
```

---

## 🔑 핵심 클래스 (5개)

### 1. MainWindow
- **책임**: 윈도우 생명주기, 사용자 이벤트 처리
- **주요 기능**: Excel 열기, 저장/로드, 키보드 단축키, 윈도우 크기 조절

### 2. DynamicUIManager
- **책임**: 동적 UI 생성 및 계층 필터링
- **핵심 메서드**:
  - `BuildUI()` - 전체 UI 구축
  - `OnHierarchySelectionChanged()` - 선택 변경 처리
  - `UpdateDependentControls()` - 하위 컨트롤 업데이트

### 3. ExcelReader
- **책임**: Excel 파일 읽기 및 데이터 파싱
- **핵심 기능**: 빈 셀을 상위 행에서 상속하여 완전한 행 데이터 생성

### 4. HierarchyTreeBuilder
- **책임**: 계층 트리 구축 및 필터링 알고리즘
- **핵심 메서드**:
  - `BuildTree()` - 재귀적 트리 구축
  - `GetAvailableValues()` - 선택 경로 기반 필터링

### 5. BoltSpecData (Data Models)
- **BoltSpecData**: Headers + DataRows
- **BoltDataRow**: Values + CompleteValues
- **HierarchyNode**: Value + Children + LeafValues
- **ControlInfo**: UI 컨트롤 메타데이터

---

## 🔄 데이터 흐름 (5단계)

```
[Excel 파일] 
    ↓ ReadExcel()
[BoltSpecData] 
    ↓ BuildTree()
[HierarchyNode Tree] 
    ↓ BuildUI()
[UI Controls] 
    ↓ User Selection → GetAvailableValues()
[Filtered Values] → UI Update
```

---

## 🌳 계층 구조

### Excel 컬럼 구조
```
컬럼1: 분류           ❌ 배제
컬럼2: 종류           📌 최상단 표시
컬럼3: 타입          ⭐ 계층 시작 (Level 1)
컬럼4: 규격(표준번호) 📂 Level 2
컬럼5: 용도          📂 Level 3
컬럼6: 재질          📂 Level 4
컬럼7: 나사종류      📂 Level 5
컬럼8: 머리형식      📂 Level 6
컬럼9: 사이즈        📂 Level 7 (ListBox)
컬럼10+: 표면처리... 🍃 리프 컬럼 (비계층)
```

### 트리 예시
```
타입=KS
├─ 규격=KS B 1002:2016
│  ├─ 용도=기계용
│  │  └─ 재질=S10C, SS400, SUS304
│  └─ 용도=PC용
│     └─ 재질=PC, RENY
└─ 규격=KS W ISO 7913:2023
   └─ 용도=항공우주용
      └─ 재질=SCM435
```

---

## ⚡ 필터링 메커니즘

### 선택 경로 (Dictionary<int, string>)
```csharp
// 초기
_selectedPath = {}

// 타입 선택
_selectedPath = {2: "KS"}

// 규격 선택
_selectedPath = {2: "KS", 3: "KS B 1002:2016"}

// 용도 선택
_selectedPath = {2: "KS", 3: "KS B 1002:2016", 4: "기계용"}
```

### 필터링 알고리즘
```
GetAvailableValues(tree, selectedPath, targetColumn):
  1. currentNodes = tree의 루트
  2. 선택된 경로를 따라 트리 탐색
  3. 목표 컬럼 도달 시 currentNodes의 모든 값 반환
  
시간 복잡도: O(D) - D는 트리 깊이 (일반적으로 < 10)
```

---

## 🎨 UI 레이아웃

```
┌─────────────────────────────────────┐
│ Menu: [파일] [편집]                 │
├─────────────────────────────────────┤
│ Category: 종류: 육각머리볼트         │
├─────────────────────────────────────┤
│ ┌────────────┬──────────────────┐   │
│ │ 작도상태   │ Canvas 1         │   │
│ │            │ [타입] ▼         │   │
│ │            │ [규격] ▼         │   │
│ │            │ [용도] ▼         │   │
│ └────────────┴──────────────────┘   │
│ ┌──────────────────────────────┐   │
│ │ Canvas 2                     │   │
│ │ [재질] ▼                      │   │
│ │ [나사종류] ▼                  │   │
│ │ [사이즈] ☐ (ListBox)         │   │
│ │ [표면처리] ▼                  │   │
│ └──────────────────────────────┘   │
├─────────────────────────────────────┤
│ [데이터보기] [초기화] [Ctrl+M]      │
└─────────────────────────────────────┘
```

---

## 🔧 주요 기능

### 1. 동적 UI 생성
- Excel 데이터 기반 완전 자동 생성
- 계층/리프 컬럼 자동 구분
- 특수 값 처리 (E: EditBox, C: CheckBox, X: Disable)

### 2. 계층 필터링
- 상위 선택 시 하위 자동 필터링
- 트리 기반 O(D) 효율적 검색
- 실시간 UI 업데이트

### 3. 컨트롤 이동
- Ctrl+M: 이동 모드 토글
- 드래그 앤 드롭으로 위치 변경
- Shift+Click: Canvas 간 이동

### 4. 자동 스케일링
- 윈도우 크기 변경 시 자동 조정
- 초기 위치 기준 비례 확대/축소
- 폰트 크기도 함께 스케일링

### 5. 저장/로드
- JSON 형식으로 상태 저장
- 위치, 선택값, Canvas 번호 포함
- Registry 기반 자동 저장

---

## 🚀 확장 가능성

### 쉽게 추가 가능한 기능
1. **새 컨트롤 타입**: NumericUpDown, DatePicker, ColorPicker
2. **검색 기능**: 컨트롤명/값 검색 및 하이라이트
3. **Export**: PDF, Excel, 이미지로 내보내기
4. **유효성 검사**: 입력값 검증 규칙 추가
5. **멀티 언어**: 한글/영어 전환
6. **실시간 동기화**: WebSocket 기반 다중 사용자

### 구조적 장점
- ✅ 계층 분리로 유지보수 용이
- ✅ 단일 책임 원칙으로 테스트 쉬움
- ✅ 동적 생성으로 하드코딩 최소화
- ✅ 트리 구조로 확장성 높음

---

## 📊 성능 특성

| 작업 | 복잡도 | 설명 |
|------|--------|------|
| Excel 읽기 | O(N*M) | N: 행, M: 컬럼 |
| 트리 구축 | O(N*D) | N: 행, D: 깊이 |
| 필터링 | O(D) | D: 깊이 (< 10) |
| UI 생성 | O(C) | C: 컨트롤 수 |
| 선택 변경 | O(C) | C: 컨트롤 수 |

**대용량 데이터 최적화 기법:**
- 지연 로딩 (Lazy Loading)
- 캐싱 (Caching)
- 가상화 (Virtualization)
- 비동기 처리 (Async/Await)

---

## 🎯 설계 원칙

### SOLID 원칙 적용
1. **단일 책임 (SRP)**: 각 클래스는 하나의 책임만
2. **개방-폐쇄 (OCP)**: 확장에는 열려있고 수정에는 닫혀있음
3. **리스코프 치환 (LSP)**: 파생 클래스는 기반 클래스를 대체 가능
4. **인터페이스 분리 (ISP)**: 클라이언트별 인터페이스 분리
5. **의존성 역전 (DIP)**: 추상화에 의존, 구체화에 의존하지 않음

### 디자인 패턴 활용
- **Builder Pattern**: UI 생성 프로세스
- **Observer Pattern**: 이벤트 핸들링
- **Strategy Pattern**: 필터링 알고리즘
- **Singleton Pattern**: UIManager, ExcelReader

---

## 📁 파일 구조

```
BoltSpecProgram/
├── MainWindow.xaml              # UI 레이아웃
├── MainWindow.xaml.cs           # 이벤트 핸들러
├── App.xaml                     # 애플리케이션 정의
├── App.xaml.cs                  # 애플리케이션 시작
├── BoltSpecData.cs              # 데이터 모델
├── ExcelReader.cs               # Excel 리더
├── UI/
│   └── DynamicUIManager.cs      # UI 관리자
└── Properties/
    ├── AssemblyInfo.cs
    ├── Resources.resx
    └── Settings.settings
```

---

## 🔑 핵심 코드 스니펫

### 1. 트리 구축
```csharp
public List<HierarchyNode> BuildTree()
{
    var rootNodes = new List<HierarchyNode>();
    foreach (var row in _data.DataRows)
        AddRowToTree(rootNodes, row, 0);
    return rootNodes;
}
```

### 2. 필터링
```csharp
public List<string> GetAvailableValues(
    List<HierarchyNode> tree, 
    Dictionary<int, string> selectedPath, 
    int targetColumnIndex)
{
    var currentNodes = tree;
    foreach (var colIndex in _hierarchyColumns)
    {
        if (colIndex == targetColumnIndex)
            return currentNodes.Select(n => n.Value).ToList();
        
        if (selectedPath.ContainsKey(colIndex))
            currentNodes = currentNodes
                .FirstOrDefault(n => n.Value == selectedPath[colIndex])
                ?.Children ?? new List<HierarchyNode>();
    }
    return new List<string>();
}
```

### 3. UI 업데이트
```csharp
private void OnHierarchySelectionChanged(int columnIndex, string value)
{
    _selectedPath[columnIndex] = value;
    UpdateDependentControls(columnIndex);
}
```

---

## 📚 참고 자료

### 기술 스택
- **언어**: C# (.NET Framework 4.7.2)
- **UI**: WPF (Windows Presentation Foundation)
- **Excel**: EPPlus 5.8.0
- **JSON**: Newtonsoft.Json 13.0.3

### 핵심 개념
- **계층 구조**: 트리 자료구조
- **동적 UI**: Reflection 없이 데이터 기반 생성
- **이벤트 핸들링**: 델리게이트와 람다
- **데이터 바인딩**: 수동 업데이트 방식

---

## 💡 Best Practices

### 코드 작성
1. ✅ 명확한 네이밍 (ColumnIndex, HierarchyNode)
2. ✅ 주석으로 의도 명시
3. ✅ 예외 처리 철저
4. ✅ Null 체크 필수

### 아키텍처
1. ✅ 계층 간 역할 분리
2. ✅ 데이터와 UI 분리
3. ✅ 비즈니스 로직 캡슐화
4. ✅ 확장 가능한 구조

### 성능
1. ✅ 불필요한 UI 업데이트 최소화
2. ✅ 대용량 데이터는 비동기 처리
3. ✅ 자주 사용하는 값은 캐싱
4. ✅ 가상화로 메모리 절약

---

## 🎓 학습 포인트

이 프로젝트에서 배울 수 있는 것:

1. **계층적 데이터 구조 설계**
   - 트리 구조 구현
   - 재귀 알고리즘
   - 깊이 우선 탐색

2. **동적 UI 생성**
   - 런타임 컨트롤 생성
   - 이벤트 동적 연결
   - Canvas 기반 레이아웃

3. **필터링 알고리즘**
   - 경로 기반 탐색
   - 효율적 검색
   - 캐싱 전략

4. **WPF 고급 기법**
   - 커스텀 컨트롤
   - 드래그 앤 드롭
   - 스케일링

5. **소프트웨어 아키텍처**
   - 계층화
   - 관심사 분리
   - SOLID 원칙

---

**이 문서는 빠른 참조용입니다. 상세 내용은 "프로그램_아키텍처_및_구조.md"를 참조하세요.**
